.PHONY: all allclean clean

CC = gcc
LFLAGS = -lm

#fast
CFLAGS	= -O2 -Wall -DAMFAST -D__USE_FIXED_PROTOTYPES__ -DUNIX_TTY_PLATFORM \
	-D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64 -DUSE_OS_MEMORY_MANAGEMENT -I.

#debug
#CFLAGS	= -g -O0 -Wall -D__USE_FIXED_PROTOTYPES__ -DUNIX_TTY_PLATFORM -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64

OBJ = starutil.o kdutil.o fileutil.o mathutil.o KD/command.o KD/amar.o KD/ambs.o KD/amdyv_array.o \
	KD/amdyv.o KD/amma.o KD/amiv.o KD/am_file.o KD/am_proc.o KD/am_string.o KD/am_string_array.o \
	KD/am_time.o KD/distances.o KD/genarray.o KD/hrect.o KD/kdtree.o KD/knn.o KD/kquery.o \
	KD/kresult.o KD/kresults.o KD/neighbors.o KD/rangesearch.o dualtree.o dualtree_max.o \
	blocklist.o kdtree/kdtree.o kdtree/kdtree_io.o dualtree_rangesearch.o healpix.o \
	hitsfile.o ioutils.o suspend.o matchfile.o lsfile.o

EXECS = randcat startree genfields quadidx solvexy fieldquads findstar findquad \
	findcode all_quads fixheaders codetomatlab startree2 deduplicate codetree2  \
	printheaders get_healpix quadidx2 xylstomatlab rdlstohealpix codedensity \
	codeprojections fixmatchfile printmatchfile rdls2hpls certifiable

# Deprecated:
#   getquads codetree 

MYOBJS = randcat.o startree.o quadidx.o genfields.o solvexy.o fieldquads.o findstar.o \
	findquad.o findcode.o starutil.o kdutil.o fileutil.o mathutil.o all_quads.o fixheaders.o codedensity.o \
	deduplicate.o codetree2.o printheaders.o test_healpix.o get_healpix.o \
	solvexy2.o quadidx2.o xylstomatlab.o rdlstohealpix.o agreeable.o slave.o \
	fixmatchfile.o printmatchfile rdls2hpls.o certifiable.o agreeable2.o \
	hitlist_agreement.o hitlist_healpix.o

# getquads.o codetree.o 

all: $(EXECS) solvexy2 agreeable slave agreeable2

solvexy2: solvexy2.o solver2.o hitlist_agreement.o $(OBJ)
	$(CC) $(CFLAGS) $(LFLAGS) $^ -o $@

agreeable: agreeable.o hitlist_agreement.o $(OBJ)
	$(CC) $(CFLAGS) $(LFLAGS) $^ -o $@

agreeable2: agreeable2.o hitlist_healpix.o $(OBJ)
	$(CC) $(CFLAGS) $(LFLAGS) $^ -o $@

slave: slave.o solver2.o $(OBJ)
	$(CC) $(CFLAGS) $(LFLAGS) $^ -o $@

$(EXECS) :: %: %.o $(OBJ)
	$(CC) $(CFLAGS) $(LFLAGS) $(OBJ) $< -o $@

%.o:	%.c
	$(CC) $(CFLAGS) -c $< -o $@

allclean:
	rm -f KD/*.o *.o $(EXECS) *~

clean:
	rm -f $(EXECS) $(MYOBJS) $(OBJ)

CUTEST_I = -Ikdtree/CuTest
CUTEST_L = kdtree/CuTest/CuTest.o 

$(CUTEST_L) :: %.o : %.c
	$(CC) $(CFLAGS) -c $< -o $@ $(CUTEST_I)

CUTEST_TEST_DRIVERS = kdtree/test_kdtree test_healpix


# Not actually used right now...
CUNIT_I = -I/h/42/dstn/software/cunit/include
CUNIT_L = /h/42/dstn/software/cunit/lib/libcunit.a
CUNIT_TEST_DRIVERS = 
CUNIT_TEST_OBJS = $(addsuffix .o,$(CUNIT_TEST_DRIVERS))
$(CUNIT_TEST_DRIVERS) :: %: %.o $(OBJ)
	$(CC) $(CFLAGS) -o $@ $^ $(CUNIT_L) -lm
$(CUNIT_TEST_OBJS) :: %.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@ $(CUNIT_I)


TEST_DRIVERS = $(CUNIT_TEST_DRIVERS) $(CUTEST_TEST_DRIVERS)

tests: $(TEST_DRIVERS)

CUTEST_TEST_OBJS = $(addsuffix .o,$(CUTEST_TEST_DRIVERS))

$(CUTEST_TEST_DRIVERS) :: %: %.o $(CUTEST_L) $(OBJ)
	$(CC) $(CFLAGS) -o $@ $^ -lm

$(CUTEST_TEST_OBJS) :: %.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@ $(CUTEST_I)

