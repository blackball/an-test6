% to-do
% -----
% - have we switched to taking quads in a circle?  if so change figure
% - need to settle on definite data release, to get definite numbers
%    of fields
% - need to settle on cascade of runs and re-run to get definite
%    numbers of failures
% - how does success and false positive rate depend on band?
% - how does it depend on field size?
% - how does it depend on star-galaxy separation?
% - how does it depend on plate scale prior?  Should we drop scale
%    determination claim from title and abstract?
% - write
% - submit

\documentclass[12pt,preprint]{aastex}

\newcommand{\latin}[1]{\textit{#1}}
\newcommand{\ie}{\latin{i.e.}}
\newcommand{\eg}{\latin{e.g.}}
\newcommand{\cf}{\latin{cf.}}
\newcommand{\etc}{\latin{etc.}}
\newcommand{\etal}{\latin{et~al.}}

\newcommand{\usnob}{USNO-B1.0}

\newcommand{\starlabel}[1]{\mathsf{#1}}
\newcommand{\AAA}{\starlabel{A}}
\newcommand{\BBB}{\starlabel{B}}
\newcommand{\CCC}{\starlabel{C}}
\newcommand{\DDD}{\starlabel{D}}
\newcommand{\NABCD}{N_{\AAA\BBB\CCC\DDD}}
\newcommand{\ENABCD}{E(\NABCD)}
\newcommand{\thetaAB}{\theta_{\AAA\BBB}}
\newcommand{\thetamin}{\theta_\mathrm{min}}
\newcommand{\thetamax}{\theta_\mathrm{max}}

\begin{document}

\title{
  Automated Astrometry I:\\
  Blind determination of image pointing, rotation, and scale
}
\author{
  [tba]
}

\begin{abstract}
We report on the first stage of an ambitious project in the automated
determination of image world coordinate systems (WCS), \ie, automated
determination of the precise relationship between $(x,y)$ positions in
an image and (RA,Dec) positions on the sky.  Our long-term goals are
\textsl{(1)}~to relieve the astronomical community of the onerous task
of solving for precise WCS, \textsl{(2)}~to locate, recover, and
repair badly archived or corrupted data, and \textsl{(3)}~to propagate
standards for the recording and transmission of WCS information.

In this first stage, we demonstrate that we can determine the WCS for
public Sloan Digital Sky Survey (SDSS) $r$-band images
($2048\times14??$~pixels, $??\times??~\mathrm{arcmin^2}$) using only
the $(x,y)$ positions in the image of compact sources, even when we
have \emph{no first guess} or prior information of any kind as to
pointing or rotation, and only an imprecise value for the plate scale.
Our system works by matching quadrangles of compact sources in the
\usnob\ astrometric catalog to quadrangles of compact sources in the
input image.  We do not require photometrically ``calibrated'' images;
star brightnesses are not used in the matching.  We employ tree
methods for fast searching.  No solutions (\ie, determinations of
pointing, orientation, and scale) are considered ``good'' unless they
lead to successful, precise WCS parameter fits.  Our system gets good
solutions for a fraction $>0.998$ (??/??) of SDSS images, with zero
false positives (fractional rate $<3\times 10^-6$).  The time to go
from the $x,y$ list of source locations in the input image to
pointing, rotation, and scale ranges from [DWH:??] to [DWH:??]~CPU~s.
By taking sub-frames of SDSS images, we show that we can reliably get
good solutions for images as small as [DWH??].
\end{abstract}

\keywords{
  methods: statistical
}

\section{Introduction}

We are entering the brave new world of enormous, heterogeneous,
distributed astronomical data sets, from many large surveys and many
data archives, including large-angle homogeneous surveys such as SDSS,
2MASS, and GALEX, and pointed observatories with large public data
archives, such as HST, Spitzer, Chandra, and NOAO.  Straightforward
interoperability of these data (\eg, comparisons, matching,
variability and proper-motion studies) requires that they all have
correct, standards-compliant astrometric (WCS) information.  The data
are not always so supplied; the community needs an automated
astrometry system that will provide.

In addition, for individudal investigators using data from
observatories, determination and storage of WCS information can be a
significant obstacle to science.  For example, even well-understood
HST images have systematic astrometric offsets (relative to the
USNO-B1.0 system, for example), and every HST image user must re-solve
the astrometry locally to do precise source matching.  There are much
more serious issues with ground-based telescope data, where the
observatory-installed WCS headers are approximate and often grossly
wrong.  In general, many person-hours go into the construction of the
WCS for a typical observing run, and in the end, the investigators
often do not encode their results in a standards-compliant way or in a
community-accessible repository, so later users (re-users) must spend
those person-hours all over again.  An automated system available to
all investigators would save the community enormous amounts of
research time, and remove a significant barrier to science.

Finally, there are many legacy data sets, such as photographic plate
archives, that are scanned (digitized), or will be scanned in the near
future.  Once in electronic form, these data have enormously increased
value for astronomy in the time-domain.  Oddly, for many
organizations, the scanning of the plate material is less onerous than
the manual data entry of pointing and rotation.  An automated system
obviates this need.

For these reasons we have begun the project of making an ``astrometry
engine'' that determines pointing, rotation, and scale for any input
image, finds best-fit values for WCS parameters, and stores that WCS
solution in the image header in a standards-compliant form.  In
principle, we would like this system to work even in cases in which
the user does not know anything about the pointing, rotation or scale
of the input image, such as when plates are newly scanned, when images
have been badly archived, or when instruments have output corrupted or
incorrect image headers.

There are several technical challenges for this project, but perhaps
the greatest is the ``blind astrometry'' problem: to determine an
image's pointing, rotation, and scale with no prior guess whatsoever.
Indeed, it is not obviously possible.  However, in a pilot project,
blind astrometry has been shown to be theoretically possible for at
least some kinds of astronomical images \citep{harvey04a}.  In cases
where scale \emph{is} known, and (importantly) the images span very
large angles (tens of degrees), it is easily solved; this is the
``lost in space'' problem, solved for satellites that need to
re-determine their orientation using images taken of star fields after
a loss of control [DWH: citation].  It has also been shown that it is
possible to determine the \emph{relative} pointing, rotation, and
scale of two images that are known to overlap, even if nothing else is
known in advance \citep{groth86a}; indeed this latter problem is the
blind astrometry problem on a small scale and its solution bears some
resemblance to the solution to the much harder problem presented
here.

In this work we use SDSS images to show that the hardest form of the
blind astrometry problem---no prior information at all about image
pointing or rotation, and only imprecise information about scale---is
solvable for real, science-grade astronomical images of varying sizes,
bandpasses, and depths.

\section{Method}

In what follows, we will describe how we determine the pointing,
rotation, and scale of an \textit{input image}, in the astrometric
system defined by a standard \textit{catalog} (here the \usnob\
catalog [DWH: reference??]), by comparing the configurations of
compact sources in the input image to configurations in the catalog.
For the purposes of what follows, we refer to any compact source as a
``\textit{star}'', though in fact the astrometrically measured sources
in deep astrometric catalogs (in particular in the the \usnob\
catalog) are not overwhelmingly stars.

The basic method we employ is to locate stars in the input image, and
look up sets of four (\textit{quadrangles}) in an \textit{index} of
stellar quadrangles created from stars in the catalog.  We then test
matches to see if they represent correct determinations of pointing,
rotation, and scale by refining the determined pointing, rotation, and
scale against the full star catalog.

\subsection{Why quadrangles?}

We want to match our input image to our catalog using stellar
configurations that are common (so the images can be expected to
contain them) but also unique (so that a match between image and
catalog configurations is decisive).

The goal of the project is to determine---without prior
knowledge---the pointing, rotation, and scale of the input image, so
once we have settled on a type of configuration, we want a
parameterization that does not depend on any of these.  For example,
if we were to index triangles, we could use ratios of the side lengths
$b/a$ and $c/a$, or one length ratio and one interior angle [DWH: cite
Groth??].  In the pointing-, rotation-, and scale-free
parameterization, triangles have two parameters, quadrangles have
four, pentagons have six, \etc, because each additional star in the
configuration adds two new parameters (which can be thought of as the
position of the new star in the scaled coordinates defined by the
other stars).

Simple configurations (\eg, triangles) live in a low-dimensional
parameter space and are therefore easy to index and search, while more
complex configurations (\eg, pentagons) require fast searches of
nearby neighbors (because of positional measurement errors in the
catalog and the input image, plus input image field distortions) in
high-dimensional spaces, which are notoriously difficult.  More
complex configurations show much more diversity (because the parameter
space is larger in dimensionality) and therefore a ``match'' between
input image and indexed configuration---given realistic uncertainties
in measurements and input image field distortion---is a more reliable
determinant of pointing, rotation, and scale.  More complex
configurations take much longer to search in an input image, because
there are $N$-choose-$n$ $n$-star configurations in an input image
containing $N$ stars (and typically $N\sim 10^3$).  More complex
configurations are also generally larger in solid angle, restricting
the possible range of input image sizes that can be solved given a
starting catalog.

Analysis of these trade-offs, given current technology, strongly
favors quadrangles.  Triangles can be searched very fast, but they are
not diverse enough to be decisive.  Pentagons are far too numerous and
high in dimensionality for fast searching.  Given the accuracy of
typical star positions in a typical input image (as we will see
below), an individual quadrangle match is generally not completely
decisive, but it is close.  Searching the quadrangles in the input
image is relatively fast, but is by far the rate-limiting process.

\subsection{Parameterizing quadrangles}

In addition to desiring a parameterization that is independent of
pointing, rotation, and scale, we can simplify the construction and
search of the quadrangle index we construct by choosing a geometric
description that uniformly fills a compact volume of parameter space.
The parameterization of quadrangles we settled on is the following:

Choose four stars (all nearby on the sky) from the catalog.  The most
widely separated pair is labeled $\AAA$ and $\BBB$ (with the choice of
which is $\AAA$ arbitrary) and the two remaining stars are labeled
$\CCC$ and $\DDD$ (again with the choice arbitrary).  Use the
mid-point between $\AAA$ and $\BBB$ as a tangent point and project all
four stars to the tangent plane so defined using the tangent
(pinhole-camera) projection.  On the tangent plane, make star $\AAA$
the point $(\AAA_u,\AAA_v)=(0,0)$ and star $\BBB$ the point
$(\BBB_u,\BBB_v)=(1,1)$ in a right-handed orthonormal coordinate
system $(u,v)$.  The parameterization of the quadrangle is then the
$(u,v)$ coordinates of stars $\CCC$ and $\DDD$, or
$(\CCC_u,\CCC_v,\DDD_u,\DDD_v)$.

In addition to the above description, we require that all indexed
quadrangles have all four coordinates $(\CCC_u,\CCC_v,\DDD_u,\DDD_v)$
each on the interval $[0,1]$ (\ie, we require that the stars $\CCC$
and $\DDD$ lie in the square box of which $\AAA$ and $\BBB$ define
opposite corners.  Figure~\ref{fig:quad} shows this parameterization
for sixteen legal quadrangles, randomly produced.

Stellar quads parameterized this way have two ambiguities:  Stars
$\AAA$ and $\BBB$ can be swapped; this effectively rotates the $u,v$
coordinate system by $\pi$, or it transforms
\begin{equation}
(\CCC_u,\CCC_v,\DDD_u,\DDD_v) \stackrel{\AAA\BBB}{\rightarrow}
  (1-\CCC_u,1-\CCC_v,1-\DDD_u,1-\DDD_v) \quad ;
\end{equation}
and stars $\CCC$ and $\DDD$ can be swapped; this exchanges $\CCC$ and
$\DDD$ in the parameter space or it transforms
\begin{equation}
(\CCC_u,\CCC_v,\DDD_u,\DDD_v) \stackrel{\CCC\DDD}{\rightarrow}
  (\DDD_u,\DDD_v,\CCC_u,\CCC_v,) \quad .
\end{equation}
There is also a third possible ambiguity: The image being solved can
have a parity opposite to that assumed.  This parity swap is an
ambiguity not for each individual quadrangle, but for the coordinate
system of all indexed quadrangles (or all quadrangles in the input
image); it effectively swaps coordinates $u$ and $v$ or it transforms
\begin{equation}
(\CCC_u,\CCC_v,\DDD_u,\DDD_v) \stackrel{\mathrm{parity}}{\rightarrow}
  (\CCC_v,\CCC_u,\DDD_v,\DDD_u) \quad .
\end{equation}

\subsection{Quadrangle statistics}

If stars are unclustered at small scales (this assumption is not valid
for any real catalog, though clustering is small in \usnob), and if
the quadrangles all span small angles, the chosen quads will fill the
four-dimensional space $(\CCC_u,\CCC_v,\DDD_u,\DDD_v)$ uniformly.  If
the angular number density (number per solid angle) of stars in the
catalog is $\Gamma$ and the catalog stars are uniformly distributed on
the sky (this assumption is also not valid for any real catalog), and
if quadrangles are considered only when the angle $\thetaAB$ between
stars $\AAA$ and $\BBB$ is between $\thetamin$ and $\thetamax$, then
the expectation value $\ENABCD$ of the total number $\NABCD$ of valid
stellar quadrangles in a large sky region is
\begin{equation}
\ENABCD = \frac{\pi}{48}\,\Gamma^4\,\Omega_\mathrm{total}\,
  [\thetamax^6-\thetamin^6] \quad ,
\end{equation}
where $\Omega_\mathrm{total}$ is the solid angle of the sky covered by
the catalog, $4\pi$~ster if the catalog is all-sky.  Because the
expectation $\ENABCD$ scales so strongly with the stellar density
$\Gamma$, the true number of allowed quads in any real stellar catalog
(which has variations in $\Gamma$ over the sky) will in fact be very
different from this homogeneous prediction.

\subsection{Index construction}

We do not index all possible quadrangles in the catalog, but rather we
make a subsample that has a limited range in $\thetaAB$, and good
coverage in parameter space and pointing on the sky.  The smallest
angular sizes $\thetaAB$ on which we can make large numbers of
quadrangles are on the order of $\thetaAB\sim\Gamma^{-(1/2)}$, or of
order arcmin with the \usnob\ catalog outside the Galactic plane.
There are of order $10^8$ patches of this size on the sky; ideally the
index ought to contain roughly this many quadrangles and fully cover
the sky.

[DWH: how do we choose quadrangles to index?]

[DWH: KD tree]

[DWH: Figure showing example catalog on sky and in code space?]

\subsection{Solving an input image}

Each parameter in the set $(\CCC_u,\CCC_v,\DDD_u,\DDD_v)$ can be
determined with an uncertainty of about $\Delta\theta/\thetaAB$, where
$\Delta\theta$ represents the combined uncertainties of the \usnob\
catalog, the stellar position determinations in the input image, and
non-square distortions in the input image.  This combined uncertainty
$\Delta\theta$ is usually of order arcsec, so for the smallest
quadrangles we can index, the uncertainty on each of the four
parameters $(\CCC_u,\CCC_v,\DDD_u,\DDD_v)$ is of order $1/60$.  The
probability that a quandrangle in the index will incorrectly match by
accident any particular quadrangle in the image is about $10^{-7}$.
If the index contains $10^8$ quadrangles, each quadrangle from the
input image will match of order 10 indexed quadrangles; finding the
image pointing, rotation, and scale is a task of finding two or more
image quadrangles that match index quadrangles that \emph{agree} on
the pointing, rotation, and scale.

[DWH: how do we make a list of compact sources in the $x,y$ coordinate
  system of the input image?]

[DWH: in what order do we loop over quadrangles?  I think we need to
  order them by brightness as reported by our star finder.]

[DWH: by what criterion do we consider a quadrangle matched?]

[DWH: how do we decide that two quadrangle matches ``agree''?]

\subsection{Testing the solution}

[DWH: how do we encode WCS?]

[DWH: how do we tweak up to a precise WCS?  To what order do we go?]

[DWH: on what basis do we decide that we tweaked to a correct WCS
  solution?]

\subsection{Limitations}

[DWH: no use of magnitudes/brightnesses except to order the stars at
  test time.]

[DWH: $\AAA$--$\BBB$ swaps, $\CCC$--$\DDD$ swaps.]

[DWH: parity]

[DWH: scalings]

\section{Results}

\section{Discussion}

\acknowledgements
It is a pleasure to thank Darcy Duke and Doug Finkbeiner for useful
discussions.  This research made use of the ``idlutils'' codebase,
maintained by David Schlegel, Doug Finkbeiner, Nikhil Padmanabhan,
MRB, DWH, and others.  This research made use of the NASA Astrophysics
Data System.

DWH and MM thank the MIT Kavli Institute for Astrophysics and Space
Research, and STR thanks the MIT Computer Science Artificial
Intelligence Laboratory, for hosting us during the period in which
most of this work was performed.

[DWH + STR: grant numbers??]

\bibliographystyle{apj}
\bibliography{apj-jour,ccpp}

\clearpage
\begin{figure}
\plotone{quad.ps}
\caption{Sixteen example quadrangles of stars.  The stars are
  represented by black boxes labeled $\AAA$, $\BBB$, $\CCC$, and
  $\DDD$.  The coordinates of stars $\CCC$ and $\DDD$ in the $u,v$
  coordinate systems defined by stars $\AAA$ and $\BBB$ are shown
  graphically with grey lines and also given numerically for each
  quadrangle.\label{fig:quad}}
\end{figure}

\end{document}
