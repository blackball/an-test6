#! /bin/bash

if [ $# -lt 4 ]; then
	echo "Usage: $0 <input-file> <output-file> <HP> <hp-list>"
	echo
	echo "<input-file> and <output-file> are FITS XY lists."
	echo "<HP> is the healpix number you want to extract."
	echo "<hp-list> is a file generated by running \"rdlstohealpix\""
	echo "    on <input-file>."
	exit
fi
in=$1
out=$2
hp=$3
hplist=$4

GAWKCMD="/HP $hp:/{for (i=3; i<NF; i++) print \$i;}"
#echo "Gawk cmd: $GAWKCMD"
FIELDS=`gawk "$GAWKCMD" $hplist`
#echo "FIELDS: $FIELDS"

for f in $FIELDS; do
	F=`printf %04i $f`
	echo "$F"
	fitsgetext -i $in -o tmp.grabhp -e 0 -e $(($f+1))
	modhead tmp.grabhp"[1]" FIELDNUM $f
	fitsgetext -i tmp.grabhp -o tmp.grabhp.$F -e 1
done
fitsgetext -i $in -o tmp.grabhp.0000 -e 0
cat tmp.grabhp.* > $out
rm tmp.grabhp.*

