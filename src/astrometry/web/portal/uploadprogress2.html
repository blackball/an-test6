<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html 
PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<style type="text/css">
p.c {margin-left:auto; margin-right:auto; text-align:center;}
table.c {margin-left:auto; margin-right:auto;}
div.c {margin-left:auto; margin-right:auto; text-align:center;}
#meter_frame { background-color:gray; width:300px; padding:1px; }
#meter_back  { background-color:white; padding:0px; }
#meter_fore  { background-color:lightblue; left:0%; width:{{ pct }}%; height:16px; }
#meter_text  { text-align:center; height:0; font-size:12px; }
</style>
<script type="text/javascript">
var req;
var reload = true;

function removeAllChildren(node) {
	while (node.childNodes.length) {
		node.removeChild(node.childNodes[0]);
	}
}

function sendRequest() {
  req = new XMLHttpRequest();
  req.onreadystatechange = contentReady;
  req.open("GET", "{{ xmlurl }}", true);
  req.send("");
}

function debug(txt) {
//  dbg = document.getElementById('debugarea');
//  dbg.value += txt + '\n';
}

function processIt() {
  if (!req) {
    return false;
  }
  if (req.readyState != 4) {
    debug('ready state = ' + req.readyState);
    return false;
  }
  if (req.status != 200) {
    debug('status = ' + req.status);
    return true;
  }
  xml = req.responseXML;
  if (!xml) {
    debug('response is not xml');
    return true;
  }
  prog = xml.getElementsByTagName('progress');
  if (!prog.length) {
    debug('no xml progress element found.');
    return true;
  }
  debug('parsing...');

  err = prog[0].getAttribute('error');
  if (err) {
    txt = document.getElementById('meter_text');
	removeAllChildren(txt);
	txt.appendChild(document.createTextNode(err));
	fore = document.getElementById('meter_fore');
    fore.style.width = '0px';
	back = document.getElementById('meter_back');
	back.style.background = 'pink';
    reload = false;
	return true;
  }

  pct = prog[0].getAttribute('pct');
  debug('pct = ' + pct);
  txt = document.getElementById('meter_text');
  removeAllChildren(txt);
  txt.appendChild(document.createTextNode('' + pct + '%'));
  fore = document.getElementById('meter_fore');
  fore.style.width = '' + pct + '%';
  if (pct == 100) {
    reload = false;
  }
  return true;
}

function contentReady() {
  if (processIt()) {
    if (reload) {
	  // do it again!
      setTimeout('sendRequest()', 2000)
    }
  }
}

function onLoad() {
  sendRequest();
}

</script>
</head>
<body onload="onLoad()">

{% comment %}
<textarea id="debugarea" rows=10 cols=80>
debug
</textarea>
{% endcomment %}

<p class="c">
<div class="c" id="meter_frame">
 <div id="meter_back">
  <div id="meter_text">{{ pct }}%</div>
  <div id="meter_fore"></div>
 </div> <!-- end meter_back -->
</div> <!-- end meter_frame -->
</p>
{% if showstats %}
<table class="c">
<tr><td>
{{ bytes_sofar }} / {{ bytes_total }}
</td></tr>
<tr><td>
{{ time_sofar }} so far
</td></tr>
<tr><td>
{{ time_remaining }} remaining
</td></tr>
</table>
{% endif %}
</body>
</html>
