<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<title>USNOB Map</title>
<script SRC="http://maps.google.com/maps?file=api&v=2&key=ABQIAAAA7dWWcc9pB-GTzZE7CvT6SRRxa-PMed253kWLIZ-c3f3fELJLuxSg2XeaAo6kezMMeatsRsfqCnbKCQ" TYPE="text/javascript"> </script>
<script SRC="wms236.js" TYPE="text/javascript"> </script>
</head>
<body>
<center>
<div id="info" style="width: 500px; height: 0px"></div>
</center>
<center>
<div id="map" style="width: 800px; height: 600px"></div>
</center>

<br>
<center>
<FORM NAME="dummyform" ACTION="" METHOD="GET">
Center RA: <INPUT TYPE="text" NAME="ra_center" VALUE="" onChange="moveCenter()" size=10>
DEC: <INPUT TYPE="text" NAME="dec_center" VALUE="" onChange="moveCenter()" size=10> degrees.
&nbsp;
Zoom level: <input type="text" name="zoom" id="zoombox" VALUE="" onChange="moveCenter()" size=4>
&nbsp;
<INPUT TYPE="button" NAME="set_center" VALUE="Go!" onClick="moveCenter()")
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;
<input type="button" name="linkhere" value="Link to this view" onClick="linktohere()">
<p>
Mouse RA: <INPUT TYPE="text" NAME="ra_mouse" VALUE="" readonly size=10>
DEC: <INPUT TYPE="text" NAME="dec_mouse" VALUE="" readonly size=10> degrees
</FORM>

<br>

<FORM name="infoform" action="" method="GET">
Number of objects in this view: <input type="text" name="nobjs" value="" readonly>
(note, this box lies)
</FORM>

<! script type="text/javascript">
  <FORM name="debugform" ACTION="" METHOD="GET">
  <textarea ROWS=5 COLS=60 NAME="debug" READONLY></textarea>
  <!  input type="hidden" name="debug" value="">
  </FORM>
<! /script>

<table width="60%">
<tr>
<td>
<br><br>
False colour method: we mapped USNO-B1 "red" ("E" and "F" band) observations
and Tycho-2 "V" and "H" observations to the R channel,
USNO-B1 "blue" ("J" and "O" band)
observations and Tycho-2 "B" and "H" observations to the G channel,
and USNO-B1 "N" observations to the B channel.
We summed the flux in each pixel (correcting for the vertical distortion
of the Mercator projection), converted back to effective magnitude,
then stretched the range of each channel
to fill the image brightness range.
<p>
This is a picture of USNO-B1, not a picture of the sky.
<form name="artifacts" ACTION="" METHOD="GET">
<select name="artifact">
<option selected value="nil" onclick="map.setCenter(new GLatLng(0,0)); map.setZoom(1);">-- View some artifacts --</option>
<option value="dupN" onclick="map.setCenter(new GLatLng(-41.4,33.6)); map.setZoom(3);">Duplicate "N" tiles</option>
<option value="dupRB" onclick="map.setCenter(new GLatLng(-15.03,198.90)); map.setZoom(5);">Duplicate red and blue tiles</option>
<option value="magel" onclick="map.setCenter(new GLatLng(-69.2,80.2)); map.setZoom(4);">Fine tiling in the Magellanic cloud</option>
<option value="crazy" onclick="map.setCenter(new GLatLng(-61.122, 221.000)); map.setZoom(5);">Craziness around bright objects</option>
<option value="crazy2" onclick="map.setCenter(new GLatLng(-3.472, 356.594)); map.setZoom(11);">Diffraction spikes and coronas</option>
</select>
</form>

</td>
</tr>
</table>
</center>
</div>

<script TYPE="text/javascript">
//<![CDATA[

function getGetData(){
	GET_DATA=new Object();
	var getDataString=new String(window.location);
	var questionMarkLocation=getDataString.search(/\?/);
	if (questionMarkLocation!=-1){
		getDataString=getDataString.substr(questionMarkLocation+1);
		var getDataArray=getDataString.split(/&/g);
		for (var i=0;i<getDataArray.length;i++){
			var nameValuePair=getDataArray[i].split(/=/);
			GET_DATA[unescape(nameValuePair[0])]=unescape(nameValuePair[1]);
		}
	}
	return GET_DATA;
}

function debug(txt) {
//document.debugform.debug.value += txt;
}

//if (GBrowserIsCompatible()) {
// var map = new GMap2(document.getElementById("map"));
var map = new GMap(document.getElementById("map"));

var BASE_URL = "http://monte.ai.toronto.edu:8080/usnob/";
var TILE_URL = BASE_URL + "tile.php?";
var USNOB_URL = TILE_URL + "map=usnob";

var getdata = getGetData();
if (("SDSS_FILE" in getdata) && ("SDSS_FIELD" in getdata)) {
  var filenum = Number(getdata["SDSS_FILE"]);
  var fieldnum = Number(getdata["SDSS_FIELD"]);
  if (filenum > 0 && filenum <= 35 && fieldnum >= 0 && fieldnum < 10000) {
    var sdss = true;
    var SDSS_URL = TILE_URL + "map=sdss" + "&SDSS_FILE=" + filenum + "&SDSS_FIELD=" + fieldnum;
  }
  if ("SDSS_QUAD" in getdata) {
    var quadstr = getdata["SDSS_QUAD"];
    debug("quadstr is " + quadstr + "\n");
    if (quadstr.match(/^\d*(,\d*){3}$/) != null) {
      debug("quadstr matches.\n");
      var fieldobjs = quadstr.match(/\d+/g);
      debug("fieldobjs is " + fieldobjs + "\n");
      if (fieldobjs != null) {
        for (var i=0; i<fieldobjs.length; i++) {
          debug("fieldobjs[" + i + "] is " + fieldobjs[i] + "\n");
        }
      }
      if (fieldobjs != null && fieldobjs.length == 4) {
        var gotquad = true;
      }
    }
  }
}
if ("HP" in getdata) {
var hp = Number(getdata["HP"]);
if (hp >= 0 && hp < 12) {
var gothp = true;
var INDEX_URL = TILE_URL + "map=index" + "&HP=" + hp;
}
  if ("INDEX_QUAD" in getdata) {
    var quadstr = getdata["INDEX_QUAD"];
    debug("quadstr is " + quadstr + "\n");
    if (quadstr.match(/^\d*(,\d*){3}$/) != null) {
      debug("quadstr matches.\n");
      var indexobjs = quadstr.match(/\d+/g);
      debug("indexobjs is " + indexobjs + "\n");
      if (indexobjs != null) {
        for (var i=0; i<indexobjs.length; i++) {
          debug("indexobjs[" + i + "] is " + indexobjs[i] + "\n");
        }
      }
      if (indexobjs != null && indexobjs.length == 4) {
        var gotindexquad = true;
      }
    }
  }
}


var overview = true;
if (("over" in getdata) && (getdata["over"] == "no")) {
  overview = false;
}

var usnobTile= new GTileLayer(new GCopyrightCollection("Catalog (c) USNO"),1,17);
usnobTile.myLayers='usnob';
usnobTile.myFormat='image/png';
usnobTile.myBaseURL=USNOB_URL;
usnobTile.getTileUrl=CustomGetTileUrl;

/*
  var usnobTile2 = new GTileLayer(new GCopyrightCollection("Catalog (c) USNO"),1,17);
  usnobTile2.myLayers='usnob lines10';
  usnobTile2.myFormat='image/png';
  usnobTile2.myBaseURL=WMS_URL;
  usnobTile2.getTileUrl=CustomGetTileUrl;
*/

var sdssTile = new GTileLayer(new GCopyrightCollection("Catalog (c) SDSS"),1,17);
sdssTile.myLayers='sdss';
sdssTile.myFormat='image/png';
sdssTile.myBaseURL=SDSS_URL;
sdssTile.getTileUrl=CustomGetTileUrl;

var indexTile = new GTileLayer(new GCopyrightCollection("Catalog (c) SDSS"),1,17);
indexTile.myLayers='index';
indexTile.myFormat='image/png';
indexTile.myBaseURL=INDEX_URL;
indexTile.getTileUrl=CustomGetTileUrl;

/*
  http://www.cs.toronto.edu/~dstn/usnob/tile.php?map=usnob&REQUEST=GetMap&SERVICE=WMS&VERSION=1.1.1&LAYERS=usnob&STYLES=&FORMAT=image/png&BGCOLOR=0xFFFFFF&TRANSPARENT=TRUE&SRS=EPSG:54004&BBOX=-13677947.379473988,4552576.405486049,-13658379.500533395,4572062.879663667&WIDTH=256&HEIGHT=256&reaspect=false
*/

var usnobType = new GMapType([usnobTile], G_SATELLITE_MAP.getProjection(), "USNOB", G_SATELLITE_MAP);
//var usnobType2 = new GMapType([usnobTile2], G_SATELLITE_MAP.getProjection(), "+Lines", G_SATELLITE_MAP);
if (sdss) {
  var usnobPlusSDSS = new GMapType([usnobTile,sdssTile], G_SATELLITE_MAP.getProjection(), "USNOB+SDSS", G_SATELLITE_MAP);
}
if (gothp) {
  var indexPlusSDSS = new GMapType([indexTile,sdssTile], G_SATELLITE_MAP.getProjection(), "INDEX+SDSS", G_SATELLITE_MAP);
}

map.getMapTypes().length = 0;
map.addMapType(usnobType);
if (sdss) {
  map.addMapType(usnobPlusSDSS);
  //map.addMapType(usnobType2);
}
if (gothp) {
  map.addMapType(indexPlusSDSS);
}
map.addControl(new GLargeMapControl());
map.addControl(new GMapTypeControl());
//map.addControl(new GScaleControl());

if (overview) {
  var w = 800;
  var h = 600;
  var ow = 150;
  var oh = 150;
  overviewControl = new GOverviewMapControl(new GSize(ow,oh));
  map.addControl(overviewControl);
  //map.hideControls([overviewControl]);
}

GEvent.bindDom(window,"resize",map,map.onResize);
// is the map moving as a result of our request?
// (this doesn't quite work with panning because it seems they deliver some
//  "moveend" events before it really has stopped moving.)
var movingmap = false;

function mapmoved() {
	debug("mapmoved(): movingmap = " + movingmap + "\n");
	if (movingmap) {
		return;
	}
	center = map.getCenter();
	// update the center ra,dec textboxes.
	ra = center.lng();
	if (ra < 0.0) { ra += 360.0; }
	document.dummyform.ra_center.value  = "" + ra;
	document.dummyform.dec_center.value = "" + center.lat();
}

function mapzoomed(oldzoom, newzoom) {
	// update the "zoom" textbox.
	document.dummyform.zoom.value = "" + newzoom;
	mapmoved();
}

function moveended() {
	debug("moveended().\n");
	if (movingmap) {
		debug("set movingmap = false.\n");
		movingmap = false;
	}
	mapmoved();
	// update the object count textbox.
	var bounds = map.getBounds();
	var pixelsize = map.getSize();
	var zoom = map.getZoom();
	var sw = bounds.getSouthWest();
	var ne = bounds.getNorthEast();
	/*
	  debug("Center (" +
	  center.lng() + "," + center.lat() + ")\n" +
	  "Bounds (" +
	  sw.lng() + "," + sw.lat() + ")-(" + ne.lng() + "," +
	  ne.lat() + ")\n" +
	  "Pixelsize (" + pixelsize.width + "," + pixelsize.height +
	  ")\n" +
	  "Zoom " + zoom + "\n");
	*/

	var COUNT_URL = "http://monte.ai.toronto.edu:8080/usnob/count.php?map=usnob";
	var url = COUNT_URL + "&center_ra=" + center.lng() + "&center_dec=" + center.lat()
		+ "&zoom=" + zoom + "&width=" + pixelsize.width + "&height=" + pixelsize.height;
	GDownloadUrl(url, function(txt) {
		document.infoform.nobjs.value = txt;
	});
}

function mousemoved(latlong) {
	var ra = latlong.lng();
	if (ra < 0.0) { ra += 360.0; }
	document.dummyform.ra_mouse.value  = "" + ra;
	document.dummyform.dec_mouse.value = "" + latlong.lat();
}

function moveCenter() {
	// "Go!" button / Enter in textfields
	debug("moveCenter() - set movingmap = true.\n");
	movingmap = true;
	var ra = document.dummyform.ra_center.value;
	var dec = document.dummyform.dec_center.value;
	var zoom = document.dummyform.zoom.value;
	// jump directly
	map.setCenter(new GLatLng(dec, ra), zoom);
}

GEvent.addListener(map, "move", mapmoved);
GEvent.addListener(map, "moveend", moveended);
GEvent.addListener(map, "zoomend", mapzoomed);
GEvent.addListener(map, "mousemove", mousemoved);

map.setCenter(new GLatLng(0,0), 0);

// if this page's URL has "ra", "dec", and "zoom" args, then go there.
function parseget() {
	var get = getGetData();
	if (("ra" in get) && ("dec" in get) && ("zoom" in get)) {
		var ra = Number(get["ra"]);
		var dec = Number(get["dec"]);
		var zoom = Number(get["zoom"]);
		//document.debugform.debug.value = "ra=" + ra + ", dec=" + dec + ", zoom=" + zoom;
		map.setZoom(zoom);
		map.setCenter(new GLatLng(dec,ra));
	}
}

// create a URL with "ra", "dec", and "zoom" GET args, and go there.
function linktohere() {
	var url=new String(window.location);
	var qm=url.search(/\?/);
	if (qm!=-1) {
		url = url.substr(0, qm);
	}
	center = map.getCenter();
	url = url + "?ra=" + center.lng() + "&dec=" + center.lat()
		+ "&zoom=" + map.getZoom();
    if (!overview) {
      url = url + "&over=no";
    }
    if (sdss) {
	  url = url + "&SDSS_FILE=$filenum&SDSS_FIELD=$fieldnum";
	}
	window.location = url;
}

var indexQuad = new GPolyline([]);
var indexOn  = "INDEX QUAD";
var indexOff = "INDEX QUAD";

var sdssQuad = new GPolyline([]);
var sdssOn  = "SDSS QUAD";
var sdssOff = "SDSS QUAD";

function IndexQuadControl() {}
IndexQuadControl.prototype = new GControl();
IndexQuadControl.prototype.initialize = function(map) {
  var on = true;
  var container = document.createElement("div");
  var toggleDiv = document.createElement("div");
  var txtNode = document.createTextNode(indexOn);
  this.setButtonStyle_(toggleDiv);
  container.appendChild(toggleDiv);
  toggleDiv.appendChild(txtNode);
  GEvent.addDomListener(toggleDiv, "click", function(){
    if (on) {
      on = false;
      map.removeOverlay(indexQuad);
      txtNode.nodeValue = indexOff;
      toggleDiv.style.fontWeight = "normal";
      toggleDiv.style.borderTopColor    = "white";
      toggleDiv.style.borderLeftColor   = "white";
      toggleDiv.style.borderBottomColor = "#b0b0b0";
      toggleDiv.style.borderRightColor  = "#b0b0b0";
    } else {
      on = true;
      map.addOverlay(indexQuad);
      txtNode.nodeValue = indexOn;
      toggleDiv.style.fontWeight = "bold";
      toggleDiv.style.borderTopColor    = "#b0b0b0";
      toggleDiv.style.borderLeftColor   = "#b0b0b0";
      toggleDiv.style.borderBottomColor = "white";
      toggleDiv.style.borderRightColor  = "white";
    }
  });
  map.getContainer().appendChild(container);
  return container;
}
IndexQuadControl.prototype.getDefaultPosition = function() {
  return new GControlPosition(G_ANCHOR_TOP_RIGHT, new GSize(7, 30));
}
IndexQuadControl.prototype.setButtonStyle_ = function(button) {
  button.style.color = "#000000";
  button.style.backgroundColor = "white";
  button.style.fontSize = "x-small";
  button.style.fontFamily = "Arial";
  button.style.fontWeight = "bold";
  button.style.borderTop    = "1px solid #b0b0b0"
  button.style.borderLeft   = "1px solid #b0b0b0";
  button.style.borderBottom = "1px solid white";
  button.style.borderRight  = "1px solid white";
  button.style.padding = "1px";
  button.style.marginBottom = "1px";
  button.style.marginTop = "1px";
  button.style.marginLeft = "1px";
  button.style.marginRight = "1px";
  button.style.textAlign = "center";
  button.style.cursor = "pointer";
}

function SdssQuadControl() {}
SdssQuadControl.prototype = new GControl();
SdssQuadControl.prototype.initialize = function(map) {
  var on = true;
  var container = document.createElement("div");
  var toggleDiv = document.createElement("div");
  var txtNode = document.createTextNode(sdssOn);
  this.setButtonStyle_(toggleDiv);
  container.appendChild(toggleDiv);
  toggleDiv.appendChild(txtNode);
  GEvent.addDomListener(toggleDiv, "click", function(){
    if (on) {
      on = false;
      map.removeOverlay(sdssQuad);
      txtNode.nodeValue = sdssOff;
      toggleDiv.style.fontWeight = "normal";
      toggleDiv.style.borderTopColor    = "white";
      toggleDiv.style.borderLeftColor   = "white";
      toggleDiv.style.borderBottomColor = "#b0b0b0";
      toggleDiv.style.borderRightColor  = "#b0b0b0";
    } else {
      on = true;
      map.addOverlay(sdssQuad);
      txtNode.nodeValue = sdssOn;
      toggleDiv.style.fontWeight = "bold";
      toggleDiv.style.borderTopColor    = "#b0b0b0";
      toggleDiv.style.borderLeftColor   = "#b0b0b0";
      toggleDiv.style.borderBottomColor = "white";
      toggleDiv.style.borderRightColor  = "white";
    }
  });
  map.getContainer().appendChild(container);
  return container;
}
SdssQuadControl.prototype.getDefaultPosition = function() {
  return new GControlPosition(G_ANCHOR_TOP_RIGHT, new GSize(100, 30));
}
SdssQuadControl.prototype.setButtonStyle_ = function(button) {
  button.style.color = "#000000";
  button.style.backgroundColor = "white";
  button.style.fontSize = "x-small";
  button.style.fontFamily = "Arial";
  button.style.fontWeight = "bold";
  button.style.borderTop    = "1px solid #b0b0b0"
  button.style.borderLeft   = "1px solid #b0b0b0";
  button.style.borderBottom = "1px solid white";
  button.style.borderRight  = "1px solid white";
  button.style.padding = "1px";
  button.style.marginBottom = "1px";
  button.style.marginTop = "1px";
  button.style.marginLeft = "1px";
  button.style.marginRight = "1px";
  button.style.textAlign = "center";
  button.style.cursor = "pointer";
}

function addquad() {
  var URL = BASE_URL + "quad.php?src=sdss&file=" + filenum + "&field=" + fieldnum +
      "&quad=" + fieldobjs[0] + "," + fieldobjs[1] + "," + fieldobjs[2] +
      "," + fieldobjs[3];

  GDownloadUrl(URL, function(data, responseCode){
  var xml = GXml.parse(data);
  var quads = xml.documentElement.getElementsByTagName("quad");
  for (var i = 0; i < quads.length; i++) {
    var points = [];
    for (var j=0; j<4; j++) {
        points.push(new GLatLng(parseFloat(quads[i].getAttribute("dec"+j)),
		                        parseFloat(quads[i].getAttribute("ra"+j))));
    }
    points.push(points[0]);
    sdssQuad = new GPolyline(points);
  }
  map.addOverlay(sdssQuad);
  map.addControl(new SdssQuadControl());
  });
}

function addindexquad() {
  var URL = BASE_URL + "quad.php?src=index&hp=" + hp +
      "&quad=" + indexobjs[0] + "," + indexobjs[1] + "," + indexobjs[2] +
      "," + indexobjs[3];

  GDownloadUrl(URL, function(data, responseCode){
  var xml = GXml.parse(data);
  var quads = xml.documentElement.getElementsByTagName("quad");
  for (var i = 0; i < quads.length; i++) {
    var points = [];
    for (var j=0; j<4; j++) {
        points.push(new GLatLng(parseFloat(quads[i].getAttribute("dec"+j)),
		                        parseFloat(quads[i].getAttribute("ra"+j))));
    }
    points.push(points[0]);
    indexQuad = new GPolyline(points, "#ff0000");
  }
  map.addOverlay(indexQuad);
  map.addControl(new IndexQuadControl());
  });
}

setTimeout("moveended();", 1);
setTimeout("mapzoomed(map.getZoom(),map.getZoom());", 2);
setTimeout("parseget()", 3);
if (gothp) {
  setTimeout("map.setMapType(indexPlusSDSS);", 4);
} else if (sdss) {
  setTimeout("map.setMapType(usnobPlusSDSS);", 4);
}
if (gotquad) {
  setTimeout("addquad();", 5);
}
if (gotindexquad) {
  setTimeout("addindexquad();", 6);
}
/*
info_html = "<b>testing</b>";
document.getElementById("info").innerHTML += info_html;
*/

/*
  <body onload="load()" onunload="GUnload()">
  <div id="map" style="width: 500px; height: 300px"></div>
  </body>
*/

//]]>
</script>

</body>
</html>
